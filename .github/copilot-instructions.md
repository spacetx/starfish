# GitHub Copilot Instructions for Starfish

## Project Overview

**starfish** is a Python library for processing images of image-based spatial transcriptomics. It provides scalable pipelines that localize and quantify RNA transcripts in image data generated by any FISH method, from simple RNA single-molecule FISH to combinatorial barcoded assays.

## Technology Stack

- **Language**: Python (3.9 - 3.12)
- **Build System**: setuptools with versioneer for version management
- **Package Management**: pip with pinned requirements
- **Testing**: pytest with pytest-cov for coverage
- **Type Checking**: mypy
- **Linting**: flake8
- **Documentation**: Sphinx with numpydoc style

## Key Dependencies

- numpy (< 2.0)
- scikit-image (> 0.22)
- scikit-learn
- xarray (< 2023.09)
- h5py
- matplotlib
- click (for CLI)
- tqdm (progress bars)

## Code Style and Standards

### Type Annotations
- All code must have typed parameters (PEP 484)
- Use typed return calls when possible
- Use inline variable annotation when type is not clear (PEP 526)

### Documentation
- Follow numpydoc style guidelines for all docstrings
- All functions and classes must be documented

### Linting Rules
- flake8 configuration in `.flake8` file
- Common ignores: E252, E301, E302, E305, E401, W503, E731, F811
- Special rules for `__init__.py` files (also ignore F401)

## Project Architecture

### Pipeline Components
The library is organized around `pipeline_component` modules that:
- Subclass a base `pipeline_component`
- Spawn command-line interfaces that track the Python API identically
- Process images through filters, feature identification, decoding, and segmentation

### Core Workflow
1. Image processing filter stages
2. Feature identification (spot-based or pixel-based)
3. Decoding features to genes via codebook mapping
4. Segmentation to identify cell membership

### Directory Structure
- `starfish/core/`: Core library code
- `starfish/core/image/Filter/`: Image filter algorithms
- `examples/`: Example pipelines and data formatting
- `notebooks/`: Jupyter notebooks (must have corresponding `.py` files via nbencdec)
- `docs/`: Sphinx documentation

## Building and Testing

### Quick Commands
```bash
make fast          # Run linting, mypy, fast tests, and build docs
make lint          # Run flake8 on all modules
make mypy          # Run type checking
make fast-test     # Run fast tests (excludes slow and napari tests)
make test          # Run all tests
make docs-html     # Build documentation
```

### Installing for Development
```bash
make install-dev   # Install with pinned requirements and CI tooling
```

### Test Organization
- Use pytest markers: `slow`, `napari`
- Fast tests run in parallel with `-n 8`
- Napari tests run sequentially (Qt compatibility)
- Coverage required with `--cov starfish`

## Adding New Features

### Creating a New Algorithm
1. Create a new file in the appropriate directory (e.g., `starfish/core/image/Filter/new_filter.py`)
2. Import the corresponding `AlgorithmBase` (e.g., `FilterAlgorithm` from `_base.py`)
3. Subclass the base and implement all required methods
4. The CLI will be auto-generated from the class definition

### Requirements Management
- Core requirements in `REQUIREMENTS.txt`
- Generated strict pins in `starfish/REQUIREMENTS-STRICT.txt`
- Use `make pin-requirements` for minimal updates
- Use `make pin-all-requirements` for full refresh

## Contribution Guidelines

### Pull Request Requirements
- Must pass all CI checks (`make all`)
- All PR comments must be addressed
- Requires at least 1 code review
- Should include a testing plan
- Squash commits to logical units on merge

### Commit Standards
- Informative summaries required
- Think about readability in the future
- Reference related issues/PRs when applicable

### Code Review Focus
- Don't break existing functionality
- Type annotations required
- Documentation required
- Tests should be comprehensive

## Common Patterns

### Working with Images
- Images are processed through filter pipelines
- Use `starfish.core.image.Filter` for image transformations
- Follow existing filter implementations as templates

### Spot Detection
- Feature identification through spot-based or pixel-based approaches
- Decoded using codebook mappings

### Segmentation
- Identifies cell membership for detected features
- Uses morphology operations

## Testing Best Practices

- Mark slow tests with `@pytest.mark.slow`
- Mark napari-dependent tests with `@pytest.mark.napari`
- Use fixtures for common test data
- Maintain test coverage above project standards
- Test edge cases and error conditions

## Documentation

- Build docs with `make docs-html`
- Follow numpydoc format for all docstrings
- Include examples in docstrings when helpful
- Update user guide for new features
- Add notebooks for complex workflows (with corresponding `.py` files)

## Helpful Commands

```bash
make help                    # Show all available targets
make check-requirements      # Verify requirements files unchanged
git describe --exact --dirty # Check current version tag
```

## Resources

- [Documentation](https://spacetx-starfish.readthedocs.io/en/latest/)
- [API Reference](https://spacetx-starfish.readthedocs.io/en/latest/api/)
- [Examples](https://spacetx-starfish.readthedocs.io/en/latest/gallery/)
- [Forum](https://forum.image.sc/tag/starfish)
